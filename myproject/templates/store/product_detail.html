{% extends 'store/base.html' %}
{% load static %}
{% block content %}
<div class="container my-5">
    <div class="row">
        <!-- Product Image -->
        <div class="col-md-6">
            <div class="product-image">
                <img src="{{ product.image.url }}" alt="{{ product.name }}" class="img-fluid rounded shadow">
            </div>
        </div>

        <!-- Product Details -->
        <div class="col-md-6">
            <h1 class="product-title mb-3">{{ product.name }}</h1>

            <div class="product-rating mb-3">
                <span class="text-warning">★ {{ product.average_rating|default:"0" }}/5</span>
                <span class="text-muted small">({{ product.total_reviews }} reviews)</span>
            </div>

            <!-- Quantity Selector -->
            <div class="mb-3 d-flex align-items-center pt-5">
                <label for="quantity" class="form-label fw-bold me-2">Quantity</label>
                <button class="btn btn-outline-secondary btn-sm" type="button" id="decrease-quantity">-</button>
                <input type="number" class="form-control mx-1" id="quantity" value="1" min="1" max="{{ product.quantity }}" style="width: 60px;">
                <button class="btn btn-outline-secondary btn-sm" type="button" id="increase-quantity">+</button>
            </div>

            <script>
                // Quantity increment/decrement buttons
                document.getElementById('increase-quantity').addEventListener('click', function() {
                    var quantityInput = document.getElementById('quantity');
                    if (parseInt(quantityInput.value) < parseInt(quantityInput.max)) {
                        quantityInput.value = parseInt(quantityInput.value) + 1;
                    }
                });

                document.getElementById('decrease-quantity').addEventListener('click', function() {
                    var quantityInput = document.getElementById('quantity');
                    if (parseInt(quantityInput.value) > 1) {
                        quantityInput.value = parseInt(quantityInput.value) - 1;
                    }
                });
            </script>

            <!-- Price Section -->
            <div class="price-section text-end mb-4">
                {% if product.discount_price < product.original_price %}
                    <span class="text-muted text-decoration-line-through">Rs. {{ product.original_price }}</span>
                    <span class="fw-bold text-danger">Rs. {{ product.discount_price }}</span>
                    <span class="badge bg-success ms-2">-{{ product.discount_percent }}% OFF</span>
                {% else %}
                    <span class="fw-bold">Rs. {{ product.original_price }}</span>
                {% endif %}
            </div>

            <div class="text-end pt-3">
                {% if product.is_in_stock %}
                    <button class="btn btn-primary" id="add-to-cart-btn">Add to Cart</button>
                {% else %}
                    <button class="btn btn-secondary" disabled>Out of Stock</button>
                {% endif %}
            </div>

            <!-- JavaScript -->
            <script>
                document.getElementById('add-to-cart-btn').addEventListener('click', function() {
                    var quantity = document.getElementById('quantity').value;
                    var productId = "{{ product.id }}";
                
                    fetch("{% url 'store:add_to_cart' product.id %}", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "X-CSRFToken": "{{ csrf_token }}"
                        },
                        body: JSON.stringify({
                            'product_id': productId,
                            'quantity': quantity
                        })
                    })
                    .then(response => {
                        if (response.status === 302) {  // Check for redirect (login required)
                            window.location.href = response.url;  // Redirect to the login page
                        } else {
                            return response.json();
                        }
                    })
                    .then(data => {
                        if (data.success) {
                            alert('Product added to cart');
                            window.location.href = "{% url 'store:view_cart' %}";
                        } else {
                            alert('Error: ' + data.error);
                        }
                    })
                    .catch(error => {
                        alert('Something went wrong. Please try again.');
                    });
                });
                
            </script>
        </div>
    </div>

    <!-- Tabs for Description and Reviews -->
    <ul class="nav nav-tabs mt-5" id="productTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="desc-tab" data-bs-toggle="tab" data-bs-target="#desc" type="button" role="tab" aria-controls="desc" aria-selected="true">
                <i class="bi bi-file-earmark-text"></i> Description
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="review-tab" data-bs-toggle="tab" data-bs-target="#review" type="button" role="tab" aria-controls="review" aria-selected="false">
                <i class="bi bi-chat-left-dots"></i> Rating & Reviews
            </button>
        </li>
    </ul>

    <div class="tab-content border p-4 mt-4">
        <!-- Description Tab -->
        <div class="tab-pane fade show active" id="desc" role="tabpanel" aria-labelledby="desc-tab">
            <h4 class="fw-bold mb-3">Product Details</h4>
            <p class="lead">{{ product.description }}</p>
        </div>

        <!-- Review Tab -->
        <div class="tab-pane fade" id="review" role="tabpanel" aria-labelledby="review-tab">
            <div class="reviews-section">
                <h4 class="fw-bold mb-3">Customer Reviews</h4>

                <!-- Display Reviews -->
                {% for review in product.reviews.all %}
                    <div class="border-bottom mb-3 pb-2" id="review-{{ review.id }}">
                        <p>
                            <button class="btn-pink border rounded btn-info btn-sm" type="button">{{ review.rating }}⭐</button>
                            <strong>{{ review.user.full_name }}</strong>
                            <small class="text-muted">({{ review.created_at|date:"F j, Y" }})</small>
                            {% if review.user == request.user %}
                            <button class="btn border rounded btn-sm btn-warning edit-review-btn p-1 m-1" style=" height: 30px;" data-review-id="{{ review.id }}">Edit</button>
                            <a href="{% url 'store:delete_review' review.id %}" class="btn border none btn-sm btn-warning p-1 m-1" style="height: 30px; ">Delete</a>
                            {% endif %}
                        </p>
                        <p>{{ review.review_text }}</p>
                        <div class="rating text-warning">
                            {% for i in "12345" %}
                                {% if i|add:0 <= review.rating %}
                                    <i class="bi bi-star-fill"></i>
                                {% else %}
                                    <i class="bi bi-star"></i>
                                {% endif %}
                            {% endfor %}
                        </div>

                        <!-- Edit Review Form (Hidden by Default) -->
                        <div id="edit-form-{{ review.id }}" class="edit-review-form" style="display: none;">
                            <form method="POST" action="{% url 'store:edit_review' review.id %}" class="mt-3">
                                {% csrf_token %}
                                <div class="mb-3">
                                    <label for="edit-review-content-{{ review.id }}" class="form-label">Your Review</label>
                                    <textarea id="edit-review-content-{{ review.id }}" name="review_text" class="form-control" rows="4" required>{{ review.review_text }}</textarea>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Rating</label>
                                    <div class="star-rating">
                                        {% for i in "12345" %}
                                            <span class="star ml-2" style="color: white; size : 20px;" data-value="{{ i }}">&#9733;</span>
                                        {% endfor %}
                                        <input type="hidden" name="rating" id="edit-rating-input-{{ review.id }}" value="{{ review.rating }}" required>
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-success">Update Review</button>
                                <button type="button" class="btn btn-secondary cancel-edit-btn" data-review-id="{{ review.id }}">Cancel</button>
                            </form>
                        </div>
                    </div>
                {% empty %}
                    <p>No reviews yet. Be the first to review this product!</p>
                {% endfor %}

                <!-- Add Review Form -->
                <h5 class="mt-4">Add a Review</h5>
                <form method="POST" action="{% url 'store:add_review' product.id %}">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="review-content" class="form-label">Your Review</label>
                        <textarea id="review-content" name="review_text" class="form-control" rows="4" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Rating</label>
                        <div class="star-rating">
                            {% for i in "12345" %}
                                <span class="star ml-2" data-value="{{ i }}">&#9733;</span>
                            {% endfor %}
                            <input type="hidden" name="rating" id="rating-input" value="0" required>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-success">Submit Review</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript for Star Rating and Edit Form -->
<script>
    // Star Rating for Add Review Form
    document.querySelectorAll('.star').forEach(star => {
        star.addEventListener('click', () => {
            const rating = star.getAttribute('data-value');
            document.getElementById('rating-input').value = rating;
            document.querySelectorAll('.star').forEach(s => {
                if (s.getAttribute('data-value') <= rating) {
                    s.style.color = '#ffc107'; // Highlight selected stars
                } else {
                    s.style.color = '#e4e5e9'; // Reset unselected stars
                }
            });
        });
    });

    // Show/Hide Edit Review Form
    document.querySelectorAll('.edit-review-btn').forEach(button => {
        button.addEventListener('click', () => {
            const reviewId = button.getAttribute('data-review-id');
            const editForm = document.getElementById(`edit-form-${reviewId}`);
            editForm.style.display = 'block'; // Show the edit form
        });
    });

    // Cancel Edit Review Form
    document.querySelectorAll('.cancel-edit-btn').forEach(button => {
        button.addEventListener('click', () => {
            const reviewId = button.getAttribute('data-review-id');
            const editForm = document.getElementById(`edit-form-${reviewId}`);
            editForm.style.display = 'none'; // Hide the edit form
        });
    });

    // Star Rating for Edit Review Form
    document.querySelectorAll('.edit-review-form .star').forEach(star => {
        star.addEventListener('click', () => {
            const rating = star.getAttribute('data-value');
            const reviewId = star.closest('.edit-review-form').id.split('-')[2];
            document.getElementById(`edit-rating-input-${reviewId}`).value = rating;
            star.closest('.star-rating').querySelectorAll('.star').forEach(s => {
                if (s.getAttribute('data-value') <= rating) {
                    s.style.color = '#ffc107'; // Highlight selected stars
                } else {
                    s.style.color = '#e4e5e9'; // Reset unselected stars
                }
            });
        });
    });
</script>

<!-- Related Items Section -->
<hr>
<h3 class="mt-5">Related Items</h3>
<div class="row">
    {% for related_product in related_products %}
        <div class="col-md-3 mb-4">
            <a href="{% url 'store:product_detail' related_product.id %}" class="text-decoration-none text-dark">
                <div class="card h-100 shadow-sm">
                    <!-- Product Image -->
                    <img src="{% if related_product.image %}{{ related_product.image.url }}{% else %}{% static 'store/images/default.png' %}{% endif %}" 
                         class="card-img-top" alt="{{ related_product.name }}" style="height: 250px; object-fit: cover;">
                    
                    <!-- Product Rating -->
                    <div class="mb-2 p-2">
                        <span class="text-warning">★ {{ related_product.rating|default:"0" }}/5</span>
                        <span class="text-muted small">({{ related_product.total_reviews }} reviews)</span>
                    </div>

                    <!-- Product Details -->
                    <div class="card-body d-flex flex-column justify-content-between">
                        <h5 class="card-title">{{ related_product.name }}</h5>

                        <!-- Product Price -->
                        <div>
                            {% if related_product.discount_price < related_product.original_price %}
                                <span class="text-muted text-decoration-line-through">Rs. {{ related_product.original_price }}</span>
                                <span class="fw-bold text-danger">Rs. {{ related_product.discount_price }}</span>
                                <span class="badge bg-success ms-2">
                                    -{{ related_product.discount_percent }}% OFF
                                </span>
                            {% else %}
                                <span class="fw-bold">Rs. {{ related_product.original_price }}</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </a>
        </div>
    {% empty %}
        <p class="text-center">No related items found.</p>
    {% endfor %}
</div>
{% endblock %}